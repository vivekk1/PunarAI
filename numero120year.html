<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numerology Mahadasha Grid</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fa;
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        #output {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 14px;
        }

        /* ===== Year Card ===== */
        .year-block {
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }

        /* Green header */
        .year-title {
            background: #2e7d32;
            color: #fff;
            text-align: center;
            font-weight: bold;
            padding: 6px 0;
            font-size: 14px;
        }

        /* ===== 3x3 Grid ===== */
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            border-top: 1px solid #ccc;
        }

        .cell {
            height: 52px;
            border: 1px solid #ccc;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
        }

        /* ===== Numbers ===== */

        /* Natal numbers (grey) */
        .natal {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        /* Destiny (green) */
        .destiny {
            color: #2e7d32;
            font-weight: bold;
            font-size: 16px;
        }

        /* Mahadasha (purple) */
        .mahadasha {
            color: #7b1fa2;
            font-size: 18px;
            font-weight: bold;
        }

        /* Personal year (orange) */
        .personal-year {
            color: #f57c00;
            font-weight: bold;
            font-size: 16px;
        }

        /* Multiple numbers spacing */
        .cell span {
            margin: 0 1px;
        }

        /* ---------- Mobile tweaks ---------- */
        @media (max-width: 480px) {
            .year-title {
                font-size: 15px;
            }

            .natal, .destiny {
                font-size: 16px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

</head>

<body>

    <div class="controls">
        <input id="dob" type="date" required>

        <input id="fromYear" type="number" placeholder="From Year">
        <input id="toYear" type="number" placeholder="To Year">

        <button onclick="loadMahadasha()">Generate</button>
        <button onclick="downloadPDF()">Download PDF</button>
    </div>


    <div id="output"></div>

    <script>
        const GRID_ORDER = [3, 1, 9, 6, 7, 5, 2, 8, 4];

        function loadMahadasha() {
            const dobInput = document.getElementById("dob");
            const d = dobInput.value;

            if (!d) {
                alert("Please select Date of Birth");
                dobInput.focus();
                return;
            }

            const [y, m, da] = d.split("-");
            const dob = `${da}-${m}-${y}`;

            fetch(`https://9c36faf0ec67.ngrok-free.app/numerology-mahadasha?dob=${dob}`, {
                headers: { "ngrok-skip-browser-warning": "true" }
            })
                .then(res => res.json())
                .then(renderAllGrids)
                .catch(() => alert("API not reachable"));
        }

        function renderAllGrids(data) {
            const container = document.getElementById("output");
            container.innerHTML = "";

            const fromYear = Number(document.getElementById("fromYear").value);
            const toYear = Number(document.getElementById("toYear").value);

            const personalYearMap = {};
            data.personal_years.forEach(p => {
                personalYearMap[p.year] = p.personal_year;
            });

            data.mahadasha.forEach(item => {

                /* APPLY YEAR FILTER */
                if (fromYear && item.year < fromYear) return;
                if (toYear && item.year > toYear) return;

                container.appendChild(
                    createYearGrid(
                        item.year,
                        item.mahadasha,
                        personalYearMap[item.year],
                        data.grid,
                        data.destiny
                    )
                );
            });

            if (!container.children.length) {
                container.innerHTML = "<p style='text-align:center;color:#6b7280'>No data for selected range</p>";
            }
        }

        function getNumberByPosition(r, c) {
            return [
                [3, 1, 9],
                [6, 7, 5],
                [2, 8, 4]
            ][r][c];
        }

        function createYearGrid(year, dasha, personalYear, natalGrid, destiny) {
            const block = document.createElement("div");
            block.className = "year-block";

            block.innerHTML = `<div class="year-title">${year}</div>`;
            const grid = document.createElement("div");
            grid.className = "grid";

            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 3; c++) {
                    const cell = document.createElement("div");
                    cell.className = "cell";

                    const cellValue = natalGrid[r][c];
                    const cellNumber = getNumberByPosition(r, c);

                    //if (cellValue !== "" && Number(cellValue) !== destiny) {
                    //    cell.innerHTML += `<span class="natal">${cellValue}</span>`;
                    //}

                    //if (cellNumber === destiny) {
                    //    cell.innerHTML += `<span class="destiny">${destiny}</span>`;
                    //}
                    if (cellValue !== "") {
                        cell.innerHTML += renderNatalWithDestiny(cellValue, destiny);
                    }

                    /* destiny overlay ONLY if destiny digit NOT in natal string */
                    if (
                        cellNumber === destiny &&
                        (!cellValue || !cellValue.includes(String(destiny)))
                    ) {
                        cell.innerHTML += `<span class="destiny">${destiny}</span>`;
                    }
                    if (cellNumber === dasha) {
                        cell.innerHTML += `<span class="mahadasha">${dasha}</span>`;
                    }

                    if (cellNumber === personalYear) {
                        cell.innerHTML += `<span class="personal-year">${personalYear}</span>`;
                    }

                    grid.appendChild(cell);
                }
            }

            block.appendChild(grid);
            return block;
        }

        function renderNatalWithDestiny(natalValue, destiny) {
            const d = String(destiny);

            if (!natalValue.includes(d)) {
                return `<span class="natal">${natalValue}</span>`;
            }

            let used = false;
            return natalValue
                .split("")
                .map(ch => {
                    if (ch === d && !used) {
                        used = true;
                        return `<span class="destiny">${ch}</span>`;
                    }
                    return `<span class="natal">${ch}</span>`;
                })
                .join("");
        }
        function downloadPDF() {
            const dob = document.getElementById("dob").value;
            if (!dob) {
                alert("Please select DOB before downloading PDF");
                return;
            }

            const element = document.getElementById("output");

            if (!element.children.length) {
                alert("No data to export");
                return;
            }

            const opt = {
                margin: 8,
                filename: `Numerology_Mahadasha_${dob}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
        }


    </script>

</body>
</html>
